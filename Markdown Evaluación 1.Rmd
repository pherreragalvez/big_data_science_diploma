---
title: "Evaluación 1 - Minería de Datos"
author: "Pablo Herrera Gálvez"
date: '2022-07-17'
output: pdf_document
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include = FALSE}
# include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.

# echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.

# message = FALSE prevents messages that are generated by code from appearing in the finished file.

# warning = FALSE prevents warnings that are generated by code from appearing in the finished.

# fig.cap = "..." adds a caption to graphical results.
```


```{r, include = FALSE}
library("readxl") # para excel correlaciones
library("dplyr")
library("ggplot2")
library(jtools) # para tablas regresion
#library("kableExtra") # para el footnote de kable
```


## Contexto.

* Se cuenta con información de 28 potenciales variables explicativas del PIB per capita para 188 países.
* Se realiza un análisis de valores atípicos u *outliers*.
* Posteriormente se plantean posibles modelos predictivos del producto de cada país.
* Por último se estiman tres modelos de regresión lineal, cada uno con sus consideraciones.

# I. Revisión de valores atípicos u outliers.

Antes de comenzar con el análisis de valores atípicos se realiza una primera revisión del total de variables contenidas en la base de datos. Se estima el coeficiente de correlación de Pearson **entre el PIB per cápita y las 28 variables numéricas restantes.**

```{r, echo = FALSE}
  # * AFECTADOS
  # * BOSQUE
  # * DESASTRE
  # * POB
  # * SUICIDIOMAS
  # * PRISION
correlaciones <- read_excel("28 correlaciones.xlsx")
correlaciones %>% rename(CORRELACIÓN = corr) %>% filter(CORRELACIÓN>-0.1) %>% filter(CORRELACIÓN<0.1) %>%
  knitr::kable(caption = "Variables con baja correlación con PIB per cápita.", digits=3) #%>%
  #footnote(general = "Estas 6 variables son ignoradas para el resto del análisis.")

# https://haozhu233.github.io/kableExtra/awesome_table_in_html.html
```

A partir de esto, se identifican 6 variables que presentan un coeficiente de correlación reducido (entre -0.1 y 0.1). Para ilustrar, se grafica un caso de baja correlación y otro de alta correlación positiva.


```{r, echo = FALSE, out.width="50%"}
paises <- read.csv("DatosPaises.csv", sep=";",header=TRUE)
plot(paises$PIB,paises$SUICIDIOMAS, main="Baja correlación entre suicidios masculinos y PIB.",
        xlab="Producto per capita",
        ylab="Tasa de suicidios masculinos")
        #, sub="Sub-title")
plot(paises$PIB,paises$DIOXIDO, main="Alta correlación entre emisiones de dióxido de carbono y PIB.",
        xlab="Producto per cápita",
        ylab="Emisiones dióxido de carbono (ton. per cápita)")
        #, sub="Sub-title")
```

Posteriornmente, se analizaron gráficamente las 22 variables restantes en busca de valores atípicos. Con esto se escogieron 5 variables que podrían presentar *outliers*. Estas cinco son el *PIB* más 4 potenciales variables explicativas: *IPC, HOMICIDIO, RENOVABLE* y *DIOXIDO*.

Para ilustrar el proceso se incluye la distribución de densidad del 50% superior del PIB y de la tasa de homicidios, lo que permite identificar valores anómalos en el extremo superior de ambas distribuciones. En el caso del producto, Qatar es el país que más se aleja del resto de la distribución, mientras que para el caso de la tasa de homicidios, sobresale Honduras.

```{r, echo=FALSE, out.width="50%"}
ggplot(paises %>% filter(PIB>mean(paises$PIB))) + geom_density(aes(x=PIB)) + labs(title = "Outlier en el tramo superior del PIB per capita.", y = "Densidad")

ggplot(paises %>% filter(HOMICIDIO>mean(paises$HOMICIDIO))) + geom_density(aes(x=HOMICIDIO)) + labs(title = "Outlier en el tramo superior de las tasas de homicidio.", y = "Densidad")

as.data.frame(head(select(paises, PAIS, PIB)[order(paises$PIB, decreasing= T),], n = 5)) %>%
  knitr::kable(caption = "Catar lidera a los países con mayor producto per capita.", digits=3)

as.data.frame(head(select(paises, PAIS, HOMICIDIO)[order(paises$HOMICIDIO, decreasing= T),], n = 5, addrownums = FALSE)) %>%
  knitr::kable(caption = "Honduras sobresale entre los países con mayor tasa de homicidio.", digits=3)
```

A las 5 variables mencionadas se les aplican tres métodos de detección de valores atípicos:

* **Método 1. Percentiles.** Como regla, se determinarán como *outliers* todos aquellos valores que formen parte del primer y último percentil de la distribución de cada una de las cinco variables.

* **Método 2. Intervalos de variabilidad.** Dicho intervalo se centra en la media de la variable y sus límites vendrán definidos por un parámetro delta y su desviación estándar. Para el ejercicio se define que el deltra tendrá valor 3.

$$
\bar{X} \pm \delta \cdot s = \bar{X} \pm 3 \cdot s
$$

* **Método 3. Valor-z robusto.** Analiza la desviación de los datos con respecto a la media. Tiene la particularidad de que el resultado no depende de la cantidad de datos, como ocurre en el Método 1, ni tampoco de estadísticos que se ven afectados por los valores extremos, como ocurre con la media y la desviación estándar del Método 2.

\
Considerando como outlier sólo aquellas observaciones que son identificadas usando los tres métodos, *RENOVABLE* presenta un outlier y el resto de las variables presentan dos observaciones atípicas cada una.

```{r, include=FALSE}
paisesout2 <- read.csv("Países con outlier.csv", sep=",",header=TRUE)
print("Outliers RENOVABLE")
table(paisesout2$outlierRENOVABLE)
print("Outliers PIB")
table(paisesout2$outlierPIB)
print("Outliers IPC")
table(paisesout2$outlierIPC)
print("Outliers HOMICIDIO")
table(paisesout2$outlierHOMICIDIO)
print("Outliers DIOXIDO")
table(paisesout2$outlierDIOXIDO)
```

Estos resultados serán considerados en el modelo final del apartado III. Se realizarán estimaciones con todas las observaciones y luego, excluyendo los ocho países que presentan al menos un outlier en las variables estudiadas.

# II. Planteamiento de hipótesis preliminares.

Del total de 28 variables, se descartaron 6. Con esto, se mantienen 22 variables que podrían ser relevantes para la estimación del PIB. Estas se organizan de acuerdo a las siguientes 5 categorías: **económicas, sociales, salud, tecnología y medio ambiente.**

\newpage
* **Variables económicas:** incluyen información de desigualdad, inflación, e información de turismo internacional.
  * GINI
  * IPC
  * FAO
  * TURISMO
\
* **Variables sociales:** incluyen índice de desarrollo humano, violencia, indicadores de género, educación y población inmigrante.
  * IDH
  * HOMICIDIO
  * VIOLENCIA
  * GENERO
  * PARLAMENTO
  * DESERCION
  * ESCOLARIDAD
  * INMIGRANTES
\
* **Variables de salud:** incluyen tasa de suicidio femenino, tasas de mortalidad infantil y maternal, y expectativa de vida al nacer.
  * SUICIDIOFEM
  * MORTINF
  * MORTMAT
  * VIDA
\
* **Variables de tecnologia y desarrollo:** incluyen tasa de electrificación, uso de internet y telefonía.
  * ELECTRICIDAD
  * INTERNET
  * CELULAR
\
* **Variables de medio ambiente:** describen uso de recursos renovables y fósiles además de emisiones de dióxido de carbono.
  * RENOVABLE
  * FOSIL
  * DIOXIDO


**Discusión sobre las variables a incluir en el modelo:**

En primer lugar, se define excluir el Índice de Desarrollo Humano (IDH) debido a que su información ya estaría contenida en otras variables. El IDH concentra información sobre salud, educación y riqueza. Los primeros dos items ya existen en otras variables explicativas, mientras que la riqueza se mide en términos del PIB per cápita (variable explicada).

En segundo lugar se identifican algunos pares de variables que resultan complementarios además de presentar una fuerte correlación entre ellos. Por esto se determina mantener una sola en cada caso. Un ejemplo de esta situación es la mortalidad de niños(as) menores de 5 años y la mortalidad maternal en partos. Ante esto, se mantiene el indicador de mortalidad maternal por presentar un mayor coeficiente de variación. El segundo caso en que esto ocurre es con el porcentaje de uso de energías renovables y combustibles fósiles. Para este caso se mantiene el indicador de energía renovable por su mayor coeficiente de variación.

```{r, include = FALSE}
coef_var <- function(x, na.rm = FALSE) {
  sd(x, na.rm=na.rm) / mean(x, na.rm=na.rm)}

coef_var(paises$MORTINF)
coef_var(paises$MORTMAT) # Se mantiene mortalidad maternal
coef_var(paises$FOSIL)
coef_var(paises$RENOVABLE) # se mantiene renovable
```

A modo de hipótesis, se espera que indicadores de mayor inflación estén asociados a una menor actividad económica, así como también se espera lo mismo ante indicadores más pobres en materia de igualdad de género, violencia y calidad de educación y salud. Por último, es razonable pensar que a mayores niveles de tecnología y desarrollo se observe un mayor producto.

```{r, include = FALSE}

# económicas
#   * GINI (-)
#   * IPC (-)
#   * FAO (-)
#   * TURISMO (+) **

# sociales
#   * IDH (+)
#   * HOMICIDIO (-)
#   * VIOLENCIA (-)
#   * GENERO (-)
#   * PARLAMENTO (+)
#   * DESERCION (-)
#   * ESCOLARIDAD (+) **
#   * INMIGRANTES (+)

# salud
#   * SUICIDIOFEM (-)
#   * MORTINF (-) **
#   * MORTMAT (-)
#   * VIDA (+) **

# tecnologia y desarrollo
#   * ELECTRICIDAD (+)
#   * INTERNET (+)
#   * CELULAR (+)

# medio ambiente
#   * RENOVABLE
#   * FOSIL
#   * DIOXIDO **
```


# III. Propuesta y estimación de un modelo de regresión lineal.

Ante las definiciones del apartado anterior, se tomarán en consideración las siguientes variables explicativas:

* **Variables económicas:**
  
  GINI, IPC, FAO y TURISMO.

* **Variables sociales:**

  HOMICIDIO, VIOLENCIA, GENERO, PARLAMENTO, DESERCION, ESCOLARIDAD e INMIGRANTES.

* **Variables de salud:**

  SUICIDIOFEM, MORTMAT y VIDA.

* **Variables de tecnologia y desarrollo:**

  ELECTRICIDAD, INTERNET y CELULAR.

* **Variables de medio ambiente:**

  RENOVABLE y DIOXIDO.

Con esto se realizarán tres estimaciones en total:

* **Estimación 1:** Incluirá las 19 variables para realizar una estimación lineal del PIB per cápita.
* **Estimación 2:** Se modifica la primera estimación aplicando logaritmo al PIB per capita.
* **Estimación 3:** Se replica la estimación 2 pero excluyendo los países con outliers identificados en el apartado I.

\newpage
## Estimación 1.

Estimación modelo lineal del PIB per capita.

```{r, echo=FALSE}
modeloP1 <- lm(PIB ~ GINI + IPC + FAO + TURISMO
               + HOMICIDIO + VIOLENCIA + GENERO + PARLAMENTO + DESERCION + ESCOLARIDAD + INMIGRANTES
               + SUICIDIOFEM + MORTMAT + VIDA
               + ELECTRICIDAD + INTERNET + CELULAR
               + RENOVABLE + DIOXIDO,
               data = paises)
```
Este modelo arroja un R cuadrado de **`r round(summary(modeloP1)$r.squared,3)`**. Además la correlación entre el PIB y el PIB predicho por el Modelo 1 es de **`r round(cor(paises$PIB , predict(modeloP1)),3)`**.

```{r, echo=FALSE, message=FALSE, warning = FALSE}
Coeficientes <- summary(modeloP1)$coefficients[,1]  # Pull out
mod_summary_sign <- summary(modeloP1)$coefficients[,3]  # Pull out p-values
Significancia <- NA                             # Named vector with significance stars
Significancia[mod_summary_sign < 0.1] <- "."
Significancia[mod_summary_sign < 0.05] <- "*"
Significancia[mod_summary_sign < 0.01] <- "**"
Significancia[mod_summary_sign < 0.001] <- "***"
Significancia[is.na(Significancia)] <- ""
names(Significancia) <- names(mod_summary_sign)
stars <- as.data.frame(Significancia)
coef <- as.data.frame(Coeficientes)
tabla1 <- merge(coef,stars, by="row.names")
tabla1 %>% knitr::kable(caption = "Estimación Modelo 1.", digits=6,
                        align=c(rep('c',times=3)),
                        col.names = c("Variable","Coeficiente","Significancia"))
```

\newpage
## Estimación 2.

Estimación modelo lineal del logaritmo del PIB per capita.

```{r, include=FALSE}
modeloP2 <- lm(log(PIB) ~ GINI + IPC + FAO + TURISMO
               + HOMICIDIO + VIOLENCIA + GENERO + PARLAMENTO + DESERCION + ESCOLARIDAD + INMIGRANTES
               + SUICIDIOFEM + MORTMAT + VIDA
               + ELECTRICIDAD + INTERNET + CELULAR
               + RENOVABLE + DIOXIDO,
               data = paises)
```


Este segundo modelo arroja un R cuadrado de **`r round(summary(modeloP2)$r.squared,3)`**. Además la correlación entre el PIB y el PIB predicho por el Modelo 2 es de **`r round(cor(log(paises$PIB) , predict(modeloP2)),3)`**.


```{r, echo=FALSE, message=FALSE, warning = FALSE}
Coeficientes <- summary(modeloP2)$coefficients[,1]  # Pull out
mod_summary_sign <- summary(modeloP2)$coefficients[,3]  # Pull out p-values
Significancia <- NA                             # Named vector with significance stars
Significancia[mod_summary_sign < 0.1] <- "."
Significancia[mod_summary_sign < 0.05] <- "*"
Significancia[mod_summary_sign < 0.01] <- "**"
Significancia[mod_summary_sign < 0.001] <- "***"
Significancia[is.na(Significancia)] <- ""
names(Significancia) <- names(mod_summary_sign)
stars <- as.data.frame(Significancia)
coef <- as.data.frame(Coeficientes)
tabla1 <- merge(coef,stars, by="row.names")
tabla1 %>% knitr::kable(caption = "Estimación Modelo 2.", digits=6,
                        align=c(rep('c',times=3)),
                        col.names = c("Variable","Coeficiente","Significancia"))
```


```{r, echo=FALSE,out.width="50%"}
plot(paises$PIB , predict(modeloP1), main="Estimación Modelo 1",
        xlab="PIB per cápita",
        ylab="Predicción del PIB per cápita")

plot(log(paises$PIB) , predict(modeloP2), main="Estimación Modelo 2",
        xlab="Logaritmo del PIB per cápita",
        ylab="Predicción del Log-PIB per cápita")

```

\newpage
## Estimación 3.

Estimación modelo lineal del logaritmo del PIB per capita excluyendo los 8 países que presentan outliers. Los 8 países excluídos en esta estimación son: Qatar, Luxemburgo, Belarus, Sudan, Venezuela, Honduras, Paraguay y Trinidad y Tobago.

```{r, include=FALSE}
paises2 <- read.csv("Países 2.csv", sep=",",header=TRUE)

modeloP3 <- lm(log(PIB) ~ GINI + IPC + FAO + TURISMO
               + HOMICIDIO + VIOLENCIA + GENERO + PARLAMENTO + DESERCION + ESCOLARIDAD + INMIGRANTES
               + SUICIDIOFEM + MORTMAT + VIDA
               + ELECTRICIDAD + INTERNET + CELULAR
               + RENOVABLE + DIOXIDO,
               data = paises2)

#summary(modeloP3)
#plot(log(paises2$PIB) , predict(modeloP3))

```

El tercer modelo arroja un R cuadrado de **`r round(summary(modeloP3)$r.squared,3)`**. Además la correlación entre el logaritmo del PIB y el logaritmo del PIB predicho por el Modelo 3 es de **`r round(cor(log(paises2$PIB) , predict(modeloP3)),3)`**.

```{r, echo=FALSE, message=FALSE, warning = FALSE}
Coeficientes <- summary(modeloP3)$coefficients[,1]  # Pull out
mod_summary_sign <- summary(modeloP3)$coefficients[,3]  # Pull out p-values
Significancia <- NA                             # Named vector with significance stars
Significancia[mod_summary_sign < 0.1] <- "."
Significancia[mod_summary_sign < 0.05] <- "*"
Significancia[mod_summary_sign < 0.01] <- "**"
Significancia[mod_summary_sign < 0.001] <- "***"
Significancia[is.na(Significancia)] <- ""
names(Significancia) <- names(mod_summary_sign)
stars <- as.data.frame(Significancia)
coef <- as.data.frame(Coeficientes)
tabla1 <- merge(coef,stars, by="row.names")
tabla1 %>% knitr::kable(caption = "Estimación Modelo 3.", digits=6,
                        align=c(rep('c',times=3)),
                        col.names = c("Variable","Coeficiente","Significancia"))
```



```{r, echo=FALSE,out.width="50%"}
plot(log(paises$PIB) , predict(modeloP2), main="Estimación Modelo 2",
        xlab="Logaritmo del PIB per cápita",
        ylab="Predicción del Log-PIB per cápita")

plot(log(paises2$PIB) , predict(modeloP3), main="Estimación Modelo 3 (sin outliers)",
        xlab="Logaritmo del PIB per cápita",
        ylab="Predicción del Log-PIB per cápita")
```

## Interpretación.

* Con el paso del modelo 1 al modelo 2 y la aplicación del logaritmo al PIB per capita, se obtienen resultados lineales. Esta modificación también trae consigo un aumento del R cuadrado ajustado y de la correlación entre la variable dependiente y su valor predicho.

* Luego con el paso del modelo 2 al modelo 3 no existen cambios importantes. Las variables explicativas que resultan significativas son las mismas en ambos casos y tampoco se diferencian el R cuadrado ajustado ni la correlación entre la variable dependiente real y la predicha por el modelo.

* Sobre las variables significativas es posible mencionar lo siguiente:
  * A mayor deserción escolar, se predicen menores valores del PIB per capita.
  * Mayores niveles de inflación están asociados a menores niveles del producto.
  * Menor igualdad de género se asocia a menores niveles del producto.
  * A menor mortalidad de la madre en parto, se observa un mayor PIB.
  * Es curioso también identificar que la estimación arroja una relación negativa entre la esperanza de vida y el PIB.


\newpage

# Anexos.

## Anexo 1. Descripción de variables.

* PIB: PIB per cápita - miles de millones de USD / habitante.
* POB: Población - millones.
* IDH: Índice de desarrollo humano.
* GINI: Coeficiente de Gini.
* IPC: Índice del precio al consumidor.
* FAO: Índice de precios alimenticios de la FAO.
* GENERO: Índice de desigualdad de género.
* ELECTRICIDAD: Tasa de electrificación.
* ESCOLARIDAD: Años de escolaridad promedio.
* SUICIDIOFEM: Tasa de suicidios femeninos - cada 100.000 personas.
* SUICIDIOMAS: Tasa de suicidios masculinos - cada 100.000 personas.
* BOSQUE: Porcentaje de superficie que corresponde a bosques.
* FOSIL: Porcentaje de uso de combustibles fósiles.
* DIOXIDO: Emisiones de dióxido de carbono - Toneladas per cápita.
* DESASTRE: Población afectada por desastres naturales - miles.
* AFECTADOS: Población sin hogar por desastres naturales - miles.
* HOMICIDIO: Tasa de homicidios - cada 100.000 personas.
* MORTINF: Mortalidad de niños menores de 5 años - miles.
* MORTMAT: Tasa de mortalidad maternal - cada 100 nacimientos.
* TURISMO: Turistas internacionales - millones.
* INTERNET: Porcentaje de uso de internet.
* VIOLENCIA: Porcentaje de víctimas de violencia entre parejas.
* VIDA: Expectativa de vida - años.
* CELULAR: Subscripciones a telefonía celular - cada 100 personas.
* DESERCION: Tasa de deserción escolar primaria.
* PRISION: Tasa de encarcelamiento - 100.000 personas.
* RENOVABLE: Porcentaje de uso de energías renovables.
* PARLAMENTO: Porcentaje de escaños parlamentarios ocupados por mujeres.
* INMIGRANTES: Porcentaje de población que es inmigrante.



